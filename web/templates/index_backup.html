<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nephrotic Syndrome Genetics Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #1e293b;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-bar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .search-results {
            position: absolute;
            top: 70px;
            left: 30px;
            right: 30px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .search-result-info {
            font-size: 0.9em;
            color: #666;
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: #666;
        }

        .search-section-title {
            padding: 10px 20px;
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
        }

        .content {
            padding: 30px;
        }

        .gene-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .gene-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gene-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.15);
        }

        .gene-card h3 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .gene-info {
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .gene-info span {
            display: block;
            margin: 5px 0;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 8px;
        }

        .badge-srns {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-ssns {
            background: #fce7f3;
            color: #be185d;
        }

        .badge-variants {
            background: #fed7aa;
            color: #c2410c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            max-width: 1200px;
            border-radius: 15px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.4);
        }

        .modal-header {
            background: #1e293b;
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 2em;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        .gene-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            margin: 10px 0;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
        }

        .detail-value {
            color: #212529;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* NEW: Citations Section Styles */
        .citations-section {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .citations-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .citations-header:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .citations-header h3 {
            margin: 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .citation-count {
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .citations-toggle {
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .citations-toggle.open {
            transform: rotate(180deg);
        }

        .citations-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .citations-body.open {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }

        .citations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 20px;
        }

        .citation-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .citation-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-decoration: none;
            color: white;
        }

        .citation-badge.pmid {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .citation-badge.pmc {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .citation-icon {
            font-size: 1.2em;
        }

        .no-citations {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .variant-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85em;
        }

        .variant-table th {
            background: #1e293b;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .variant-table td {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .variant-table tr:hover {
            background: #f8f9fa;
        }

        .variant-table td:nth-child(3),
        .variant-table td:nth-child(4),
        .variant-table td:nth-child(5),
        .variant-table td:nth-child(6),
        .variant-table td:nth-child(7),
        .variant-table td:nth-child(8) {
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        .significant {
            color: #dc3545;
            font-weight: bold;
        }

        .kept-variant {
            color: #28a745;
        }

        .pruned-variant {
            color: #6c757d;
        }

        .viz-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .viz-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .db-link {
            display: inline-block;
            background: #0ea5e9;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            text-decoration: none;
            margin: 2px;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .db-link:hover {
            background: #0284c7;
            text-decoration: none;
        }

        .pathway-btn {
            display: inline-block;
            background: #8b5cf6;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            text-decoration: none;
            margin-left: 10px;
            font-size: 0.85em;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .pathway-btn:hover {
            background: #7c3aed;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
            text-decoration: none;
        }

        #chromosomeChart {
            cursor: pointer;
        }

        #chromosomeGeneList {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #chromListTitle {
            color: #1e293b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3b82f6;
        }

        .loading {
            text-align: center;
            padding: 60px 40px;
            color: #666;
        }

        /* DNA Helix Loading Animation */
        .dna-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .dna-helix {
            position: relative;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dna-strand {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: dnaRotate 1.5s ease-in-out infinite;
        }

        .dna-strand:nth-child(1) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation-delay: 0s;
        }

        .dna-strand:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation-delay: 0.1s;
        }

        .dna-strand:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            animation-delay: 0.2s;
        }

        .dna-strand:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            animation-delay: 0.3s;
        }

        .dna-strand:nth-child(5) {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            animation-delay: 0.4s;
        }

        .dna-strand:nth-child(6) {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            animation-delay: 0.5s;
        }

        @keyframes dnaRotate {
            0% {
                transform: rotate(0deg) translateX(35px) rotate(0deg);
                opacity: 1;
                scale: 1;
            }
            25% {
                opacity: 0.7;
                scale: 1.2;
            }
            50% {
                transform: rotate(180deg) translateX(35px) rotate(-180deg);
                opacity: 1;
                scale: 1;
            }
            75% {
                opacity: 0.7;
                scale: 1.2;
            }
            100% {
                transform: rotate(360deg) translateX(35px) rotate(-360deg);
                opacity: 1;
                scale: 1;
            }
        }

        .loading-text {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e293b;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loading-subtext {
            font-size: 0.9em;
            color: #64748b;
            margin-top: 5px;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        a {
            color: #3b82f6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Filter and Pagination Styles */
        .variant-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-label {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
            display: block;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #cbd5e1;
            background: white;
            color: #475569;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #2563eb;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .filter-btn.active:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
        }

        .variant-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .filter-btn.active .variant-count {
            background: rgba(255,255,255,0.4);
        }

        .pagination-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-selector label {
            font-weight: 600;
            color: #475569;
            font-size: 0.9em;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            background: white;
            color: #475569;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-size-selector select:hover {
            border-color: #3b82f6;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .page-btn {
            padding: 8px 12px;
            border: 2px solid #cbd5e1;
            background: white;
            color: #475569;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 40px;
        }

        .page-btn:hover:not(:disabled) {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #2563eb;
        }

        .page-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            color: #475569;
            font-size: 0.9em;
            font-weight: 600;
        }

        /* Statistics Row Styles */
        .stats-container {
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .stat-box {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #cbd5e1;
            transition: all 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .stat-box.significant {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff 0%, #fee 100%);
        }

        .stat-box.highly-significant {
            border-left-color: #c92a2a;
            background: linear-gradient(135deg, #fff 0%, #fdd 100%);
        }

        .stat-pop-name {
            font-weight: 700;
            font-size: 0.95em;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-sig-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .stat-value-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            font-size: 0.85em;
        }

        .stat-label {
            color: #64748b;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #1e293b;
        }

        .stat-value.significant-p {
            color: #dc3545;
            font-weight: 700;
        }

        .stat-value.significant-fst {
            color: #f97316;
            font-weight: 700;
        }

        .stats-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #cbd5e1;
        }

        .stats-header h4 {
            color: #1e293b;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .stats-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #cbd5e1;
            font-size: 0.85em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #64748b;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.p-value {
            background: #dc3545;
        }

        .legend-dot.fst-value {
            background: #f97316;
        }

        .view-stats-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .view-stats-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .no-stats {
            text-align: center;
            padding: 30px;
            color: #64748b;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§¬ Nephrotic Syndrome Genetics Database</h1>
            <p>Genetic Diversity in Nephrotic Syndrome Risk Alleles Across Populations</p>
        </div>

        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" 
                   placeholder="ðŸ” Search genes by name or Ensembl ID (e.g., NPHS1, ENSG00000167641)...">
            <div class="search-results" id="searchResults"></div>
        </div>

        <div class="content">
            <div class="stats-grid" id="statsGrid"></div>
            
            <div style="margin-bottom: 40px;">
                <h2 style="margin-bottom: 15px;">ðŸ§¬ Genes by Chromosome</h2>
                <div id="chromosomeChart" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <canvas id="chromCanvas"></canvas>
                </div>
                <div id="chromosomeGeneList" style="display: none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 id="chromListTitle"></h3>
                    <div id="chromGenes" class="gene-grid"></div>
                </div>
            </div>
            
            <h2 style="margin-bottom: 15px;">Gene List</h2>
            <div class="gene-grid" id="geneGrid">
                <div class="loading" style="grid-column: 1 / -1;">
                    <div class="dna-loader">
                        <div class="dna-helix">
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                        </div>
                        <div class="loading-text">
                            Loading genes<span class="loading-dots"></span>
                        </div>
                        <div class="loading-subtext">Fetching genetic data from database</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="geneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalGeneTitle">Gene Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="dna-loader">
                        <div class="dna-helix">
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                        </div>
                        <div class="loading-text">
                            Loading gene details<span class="loading-dots"></span>
                        </div>
                        <div class="loading-subtext">Please wait while we fetch the data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let allGenes = [];
        let charts = {};
        let chromosomeChart = null;
        let genesByChromosome = {};
        let searchTimeout = null;
        
        // Variant filtering and pagination state
        let currentVariants = [];
        let filteredVariants = [];
        let currentFilter = 'all';
        let currentPage = 1;
        let variantsPerPage = 50;
        let currentGeneName = '';

        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/statistics`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    const statsHTML = `
                        <div class="stat-card">
                            <h3>${stats.total_genes}</h3>
                            <p>Total Genes</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.total_variants.toLocaleString()}</h3>
                            <p>Total Variants</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.significant_variants.toLocaleString()}</h3>
                            <p>Significant Variants</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.variants_per_gene.avg}</h3>
                            <p>Avg Variants/Gene</p>
                        </div>
                    `;
                    document.getElementById('statsGrid').innerHTML = statsHTML;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadGenes() {
            try {
                const response = await fetch(`${API_BASE}/genes`);
                const data = await response.json();
                
                if (data.success) {
                    allGenes = data.data;
                    displayGenes(allGenes);
                    createChromosomeChart(allGenes);
                }
            } catch (error) {
                document.getElementById('geneGrid').innerHTML = 
                    '<p style="color: red;">Error loading genes. Make sure the API server is running!</p>';
            }
        }

        function createChromosomeChart(genes) {
            genesByChromosome = {};
            const chromosomes = ['1','2','3','4','5','6','7','8','9','10','11','12',
                                '13','14','15','16','17','18','19','20','21','22','X','Y'];
            
            chromosomes.forEach(chr => {
                genesByChromosome[chr] = genes.filter(g => {
                    const geneChr = (g.chromosome || '').replace('chr', '');
                    return geneChr === chr;
                });
            });

            const counts = chromosomes.map(chr => genesByChromosome[chr].length);
            
            const ctx = document.getElementById('chromCanvas').getContext('2d');
            if (chromosomeChart) chromosomeChart.destroy();
            
            chromosomeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chromosomes.map(c => 'Chr ' + c),
                    datasets: [{
                        label: 'Number of Genes',
                        data: counts,
                        backgroundColor: chromosomes.map((c, i) => 
                            i % 2 === 0 ? '#3b82f6' : '#60a5fa'
                        ),
                        borderColor: '#2563eb',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const chromosome = chromosomes[index];
                            showChromosomeGenes(chromosome);
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution of Nephrotic Syndrome Genes Across Chromosomes (Click to view genes)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} genes`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Genes',
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: { stepSize: 5 }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Chromosome',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function showChromosomeGenes(chromosome) {
            const genes = genesByChromosome[chromosome] || [];
            const listDiv = document.getElementById('chromosomeGeneList');
            const titleDiv = document.getElementById('chromListTitle');
            const genesDiv = document.getElementById('chromGenes');
            
            titleDiv.textContent = `Genes on Chromosome ${chromosome} (${genes.length} genes)`;
            
            if (genes.length === 0) {
                genesDiv.innerHTML = '<p>No genes found on this chromosome</p>';
            } else {
                genesDiv.innerHTML = genes.map(gene => `
                    <div class="gene-card" onclick="viewGene('${gene.gene_name}')">
                        <h3>${gene.gene_name}</h3>
                        <div class="gene-info">
                            <span><strong>Ensembl:</strong> ${gene.ensembl_id || 'N/A'}</span>
                            <span><strong>Chr:</strong> ${gene.chromosome || 'N/A'}</span>
                            ${gene.srns_ssns ? `<span class="badge badge-srns">${gene.srns_ssns}</span>` : ''}
                            <span class="badge badge-variants">${gene.variant_count} variants</span>
                        </div>
                    </div>
                `).join('');
            }
            
            listDiv.style.display = 'block';
            listDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displayGenes(genes) {
            const grid = document.getElementById('geneGrid');
            
            if (genes.length === 0) {
                grid.innerHTML = '<p>No genes found</p>';
                return;
            }

            grid.innerHTML = genes.map(gene => `
                <div class="gene-card" onclick="viewGene('${gene.gene_name}')">
                    <h3>${gene.gene_name}</h3>
                    <div class="gene-info">
                        <span><strong>Ensembl:</strong> ${gene.ensembl_id || 'N/A'}</span>
                        <span><strong>Chr:</strong> ${gene.chromosome || 'N/A'}</span>
                        ${gene.srns_ssns ? `<span class="badge badge-srns">${gene.srns_ssns}</span>` : ''}
                        <span class="badge badge-variants">${gene.variant_count} variants</span>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('searchInput').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (searchTerm === '') {
                searchResults.classList.remove('active');
                displayGenes(allGenes);
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(searchTerm)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const genes = data.results.genes || [];
                        const variants = data.results.variants || [];
                        
                        if (genes.length > 0 || variants.length > 0) {
                            let html = '';
                            
                            if (genes.length > 0) {
                                html += '<div class="search-section-title">Genes</div>';
                                genes.forEach(gene => {
                                    html += `
                                        <div class="search-result-item" onclick="selectSearchResult('${gene.gene_name}')">
                                            <div class="search-result-title">${gene.gene_name}</div>
                                            <div class="search-result-info">
                                                ${gene.ensembl_id || 'No Ensembl ID'} â€¢ 
                                                Chr ${gene.chromosome || 'N/A'} â€¢ 
                                                ${gene.srns_ssns || 'N/A'}
                                            </div>
                                        </div>
                                    `;
                                });
                            }
                            
                            if (variants.length > 0) {
                                html += '<div class="search-section-title">Variants</div>';
                                variants.slice(0, 10).forEach(variant => {
                                    html += `
                                        <div class="search-result-item" onclick="selectVariantResult('${variant.gene_name}', '${variant.rs_id}')">
                                            <div class="search-result-title">${variant.rs_id}</div>
                                            <div class="search-result-info">
                                                ${variant.chrom}:${variant.position.toLocaleString()} â€¢ 
                                                Gene: ${variant.gene_name}
                                            </div>
                                        </div>
                                    `;
                                });
                                if (variants.length > 10) {
                                    html += `<div class="search-no-results">... and ${variants.length - 10} more variants</div>`;
                                }
                            }
                            
                            searchResults.innerHTML = html;
                            searchResults.classList.add('active');
                        } else {
                            searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
                            searchResults.classList.add('active');
                        }
                        
                        displayGenes(genes);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    searchResults.innerHTML = '<div class="search-no-results">Search error</div>';
                    searchResults.classList.add('active');
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        function selectSearchResult(geneName) {
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('searchInput').value = '';
            viewGene(geneName);
        }

        function selectVariantResult(geneName, rsId) {
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('searchInput').value = '';
            viewGene(geneName);
        }

        function toggleCitations(geneName) {
            const body = document.getElementById(`citations-body-${geneName}`);
            const toggle = document.getElementById(`citations-toggle-${geneName}`);
            
            body.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function applyVariantFilter(filter) {
            currentFilter = filter;
            currentPage = 1;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Filter variants
            if (filter === 'all') {
                filteredVariants = [...currentVariants];
            } else if (filter === 'significant') {
                filteredVariants = currentVariants.filter(v => v.is_significant);
            } else if (filter === 'after-ld') {
                filteredVariants = currentVariants.filter(v => v.in_ld === 'Yes');
            } else if (filter === 'both') {
                filteredVariants = currentVariants.filter(v => v.is_significant && v.in_ld === 'Yes');
            }
            
            displayVariants();
        }

        function changePageSize(size) {
            variantsPerPage = parseInt(size);
            currentPage = 1;
            displayVariants();
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredVariants.length / variantsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            displayVariants();
        }

        function showVariantStats(rsId, statistics) {
            const statsRow = document.getElementById(`stats-row-${rsId}`);
            
            if (statsRow.style.display === 'none') {
                // Close any other open stats rows and chart rows
                document.querySelectorAll('[id^="stats-row-"]').forEach(row => {
                    if (row.id !== `stats-row-${rsId}`) {
                        row.style.display = 'none';
                    }
                });
                document.querySelectorAll('[id^="chart-row-"]').forEach(row => {
                    row.style.display = 'none';
                });
                
                statsRow.style.display = 'table-row';
                
                // Build statistics display
                if (!statistics || statistics.length === 0) {
                    statsRow.querySelector('.stats-container').innerHTML = 
                        '<div class="no-stats">No statistical data available for this variant</div>';
                    return;
                }
                
                // Sort by significance (significant first)
                const sortedStats = [...statistics].sort((a, b) => {
                    if (a.is_significant_bonferroni && !b.is_significant_bonferroni) return -1;
                    if (!a.is_significant_bonferroni && b.is_significant_bonferroni) return 1;
                    return (b.fst_value || 0) - (a.fst_value || 0);
                });
                
                const statsHTML = `
                    <div class="stats-header">
                        <h4>ðŸ“Š Population-Specific Statistics - ${rsId}</h4>
                        <div style="font-size: 0.9em; color: #64748b;">
                            Statistical significance across different populations
                        </div>
                    </div>
                    <div class="stats-grid">
                        ${sortedStats.map(stat => {
                            const isSigBonf = stat.is_significant_bonferroni;
                            const isSigFst = stat.is_significant_fst;
                            const pValue = stat.chi_square_p_value;
                            const fstValue = stat.fst_value;
                            
                            const boxClass = isSigBonf ? (pValue <= 0.001 ? 'highly-significant' : 'significant') : '';
                            
                            return `
                                <div class="stat-box ${boxClass}">
                                    <div class="stat-pop-name">
                                        <span>${stat.population}</span>
                                        ${isSigBonf ? '<span class="stat-sig-badge">âœ“ SIG</span>' : ''}
                                    </div>
                                    <div class="stat-value-row">
                                        <span class="stat-label">p-value:</span>
                                        <span class="stat-value ${isSigBonf ? 'significant-p' : ''}">
                                            ${pValue !== null && pValue !== undefined ? pValue.toExponential(3) : 'N/A'}
                                        </span>
                                    </div>
                                    <div class="stat-value-row">
                                        <span class="stat-label">FST:</span>
                                        <span class="stat-value ${isSigFst ? 'significant-fst' : ''}">
                                            ${fstValue !== null && fstValue !== undefined ? fstValue.toFixed(4) : 'N/A'}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="stats-legend">
                        <div class="legend-item">
                            <div class="legend-dot p-value"></div>
                            <span>p-value â‰¤ 0.01 (Bonferroni)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot fst-value"></div>
                            <span>FST â‰¥ 0.15</span>
                        </div>
                        <div class="legend-item">
                            <span><strong>SIG</strong> = Significant (Bonferroni-corrected)</span>
                        </div>
                    </div>
                `;
                
                statsRow.querySelector('.stats-container').innerHTML = statsHTML;
            } else {
                statsRow.style.display = 'none';
            }
        }

        function displayVariants() {
            const totalPages = Math.ceil(filteredVariants.length / variantsPerPage);
            const startIdx = (currentPage - 1) * variantsPerPage;
            const endIdx = Math.min(startIdx + variantsPerPage, filteredVariants.length);
            const pageVariants = filteredVariants.slice(startIdx, endIdx);
            
            // Update variant count in filter buttons
            const allCount = currentVariants.length;
            const sigCount = currentVariants.filter(v => v.is_significant).length;
            const ldCount = currentVariants.filter(v => v.in_ld === 'Yes').length;
            const bothCount = currentVariants.filter(v => v.is_significant && v.in_ld === 'Yes').length;
            
            document.querySelector('[data-filter="all"] .variant-count').textContent = allCount;
            document.querySelector('[data-filter="significant"] .variant-count').textContent = sigCount;
            document.querySelector('[data-filter="after-ld"] .variant-count').textContent = ldCount;
            document.querySelector('[data-filter="both"] .variant-count').textContent = bothCount;
            
            // Generate table rows
            const tableBody = document.getElementById('variantsTableBody');
            tableBody.innerHTML = pageVariants.map(v => {
                const af = v.allele_frequencies;
                const stats = v.statistics || [];
                const statsJson = JSON.stringify(stats).replace(/"/g, '&quot;');
                
                return `
                    <tr>
                        <td>
                            ${v.dbsnp_link ? 
                                `<a href="${v.dbsnp_link}" target="_blank" title="View in dbSNP"><strong>${v.rs_id}</strong></a>` : 
                                `<strong>${v.rs_id}</strong>`}
                        </td>
                        <td>${v.chrom}:${v.position.toLocaleString()}</td>
                        <td>${v.ref_allele}/${v.alt_allele}</td>
                        <td>${af.EUR !== undefined ? af.EUR.toFixed(4) : 'N/A'}</td>
                        <td>${af.AFR !== undefined ? af.AFR.toFixed(4) : 'N/A'}</td>
                        <td>${af.AMR !== undefined ? af.AMR.toFixed(4) : 'N/A'}</td>
                        <td>${af.EAS !== undefined ? af.EAS.toFixed(4) : 'N/A'}</td>
                        <td>${af.SAS !== undefined ? af.SAS.toFixed(4) : 'N/A'}</td>
                        <td class="${v.in_ld === 'Yes' ? 'kept-variant' : 'pruned-variant'}">
                            ${v.in_ld === 'Yes' ? 'âœ“ Kept' : 'âœ— Pruned'}
                        </td>
                        <td class="${v.is_significant ? 'significant' : ''}">
                            ${v.is_significant ? 
                                `<button class="view-stats-btn" onclick='showVariantStats("${v.rs_id}", ${statsJson})'>
                                    ðŸ“Š View Stats
                                </button>` : 
                                'No'}
                        </td>
                        <td>
                            <button class="viz-btn" onclick="showChart('${v.rs_id}', ${JSON.stringify(af).replace(/"/g, '&quot;')}, ${v.global_af || 0})">
                                ðŸ“Š Chart
                            </button>
                        </td>
                    </tr>
                    <tr id="stats-row-${v.rs_id}" style="display: none;">
                        <td colspan="11" style="padding: 0;">
                            <div class="stats-container">
                                Loading statistics...
                            </div>
                        </td>
                    </tr>
                    <tr id="chart-row-${v.rs_id}" style="display: none;">
                        <td colspan="11" style="padding: 20px; background: #f8f9fa;">
                            <div style="max-width: 800px; margin: 0 auto;">
                                <canvas id="chart-${v.rs_id}"></canvas>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination info
            document.getElementById('pageInfo').textContent = 
                `Showing ${startIdx + 1}-${endIdx} of ${filteredVariants.length} variants`;
            
            // Generate pagination buttons
            const paginationControls = document.getElementById('paginationControls');
            let paginationHTML = `
                <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    â—€ Prev
                </button>
            `;
            
            // Show max 7 page numbers
            let startPage = Math.max(1, currentPage - 3);
            let endPage = Math.min(totalPages, currentPage + 3);
            
            if (startPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="page-info">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="page-info">...</span>`;
                }
                paginationHTML += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            paginationHTML += `
                <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next â–¶
                </button>
            `;
            
            paginationControls.innerHTML = paginationHTML;
        }

        async function viewGene(geneName) {
            const modal = document.getElementById('geneModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalGeneTitle');
            
            modal.style.display = 'block';
            modalTitle.textContent = geneName;
            modalBody.innerHTML = `
                <div class="loading">
                    <div class="dna-loader">
                        <div class="dna-helix">
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                            <div class="dna-strand"></div>
                        </div>
                        <div class="loading-text">
                            Loading ${geneName} details<span class="loading-dots"></span>
                        </div>
                        <div class="loading-subtext">Fetching variants and annotations</div>
                    </div>
                </div>
            `;

            try {
                const geneResponse = await fetch(`${API_BASE}/gene/${geneName}`);
                const geneData = await geneResponse.json();

                const variantsResponse = await fetch(`${API_BASE}/gene/${geneName}/variants`);
                const variantsData = await variantsResponse.json();

                if (geneData.success && variantsData.success) {
                    const gene = geneData.data;
                    const variants = variantsData.data;

                    // Store variants for filtering/pagination
                    currentVariants = variants;
                    filteredVariants = variants;
                    currentGeneName = geneName;
                    currentFilter = 'all';
                    currentPage = 1;

                    // Build citations section
                    let citationsHTML = '';
                    if (gene.citations && gene.citations.length > 0) {
                        citationsHTML = `
                            <div class="citations-section">
                                <div class="citations-header" onclick="toggleCitations('${geneName}')">
                                    <h3>
                                        ðŸ“š Citations & References
                                        <span class="citation-count">${gene.citations.length} paper${gene.citations.length > 1 ? 's' : ''}</span>
                                    </h3>
                                    <span class="citations-toggle" id="citations-toggle-${geneName}">â–¼</span>
                                </div>
                                <div class="citations-body" id="citations-body-${geneName}">
                                    <div class="citations-grid">
                                        ${gene.citations.map(citation => `
                                            <a href="${citation.url}" target="_blank" class="citation-badge ${citation.type.toLowerCase()}">
                                                <span class="citation-icon">${citation.type === 'PMC' ? 'ðŸ“„' : 'ðŸ”¬'}</span>
                                                <span>${citation.type}: ${citation.id}</span>
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    modalBody.innerHTML = `
                        ${citationsHTML}

                        <div class="gene-details">
                            <h3>Gene Information</h3>
                            <div class="detail-row">
                                <div class="detail-label">Gene Name:</div>
                                <div class="detail-value"><strong>${geneName}</strong></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Ensembl ID:</div>
                                <div class="detail-value">
                                    ${gene.ensembl_id ? 
                                        `<a href="https://www.ensembl.org/Homo_sapiens/Gene/Summary?g=${gene.ensembl_id}" target="_blank">${gene.ensembl_id}</a>` : 
                                        'N/A'}
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Chromosome:</div>
                                <div class="detail-value">${gene.chromosome ? `chr${gene.chromosome.replace('chr', '')}` : 'N/A'}</div>
                            </div>
                            ${gene.start_position && gene.end_position ? `
                            <div class="detail-row">
                                <div class="detail-label">Genomic Position:</div>
                                <div class="detail-value">${gene.start_position.toLocaleString()} - ${gene.end_position.toLocaleString()} (${((gene.end_position - gene.start_position) / 1000).toFixed(1)} kb)</div>
                            </div>
                            ` : ''}
                            <div class="detail-row">
                                <div class="detail-label">SRNS/SSNS:</div>
                                <div class="detail-value"><span class="badge badge-srns">${gene.srns_ssns || 'N/A'}</span></div>
                            </div>
                            ${gene.function_link ? `
                            <div class="detail-row">
                                <div class="detail-label">Function:</div>
                                <div class="detail-value">
                                    <a href="${gene.function_link}" target="_blank" class="pathway-btn" title="View gene function">
                                        ðŸ§¬ View Function
                                    </a>
                                </div>
                            </div>
                            ` : ''}
                            ${gene.pathway_link ? `
                            <div class="detail-row">
                                <div class="detail-label">Pathway:</div>
                                <div class="detail-value">
                                    <a href="${gene.pathway_link}" target="_blank" class="pathway-btn" title="View pathway">
                                        ðŸ”¬ View Pathway
                                    </a>
                                </div>
                            </div>
                            ` : ''}
                            ${gene.phenotypes ? `
                            <div class="detail-row">
                                <div class="detail-label">Phenotypes:</div>
                                <div class="detail-value">${gene.phenotypes}</div>
                            </div>
                            ` : ''}
                            ${gene.inheritance ? `
                            <div class="detail-row">
                                <div class="detail-label">Inheritance:</div>
                                <div class="detail-value">${gene.inheritance}</div>
                            </div>
                            ` : ''}
                            <div class="detail-row">
                                <div class="detail-label">Database Links:</div>
                                <div class="detail-value">
                                    ${gene.omim_link ? `<a href="${gene.omim_link}" target="_blank" class="db-link">OMIM</a>` : ''}
                                    ${gene.gwas_link ? `<a href="${gene.gwas_link}" target="_blank" class="db-link">GWAS</a>` : ''}
                                    ${gene.clinpgx_link ? `<a href="${gene.clinpgx_link}" target="_blank" class="db-link">ClinPGx</a>` : ''}
                                    ${gene.malacards_link ? `<a href="${gene.malacards_link}" target="_blank" class="db-link">MalaCards</a>` : ''}
                                    ${!gene.omim_link && !gene.gwas_link && !gene.clinpgx_link && !gene.malacards_link ? 'N/A' : ''}
                                </div>
                            </div>
                        </div>

                        <h3 style="margin-top: 30px; margin-bottom: 15px;">Variants</h3>
                        
                        <div class="variant-controls">
                            <div class="filter-section">
                                <label class="filter-label">ðŸ” Filter Variants</label>
                                <div class="filter-buttons">
                                    <button class="filter-btn active" data-filter="all" onclick="applyVariantFilter('all')">
                                        <span>ðŸ“Š All Variants</span>
                                        <span class="variant-count">0</span>
                                    </button>
                                    <button class="filter-btn" data-filter="significant" onclick="applyVariantFilter('significant')">
                                        <span>âœ¨ Significant Only</span>
                                        <span class="variant-count">0</span>
                                    </button>
                                    <button class="filter-btn" data-filter="after-ld" onclick="applyVariantFilter('after-ld')">
                                        <span>ðŸ”— After LD Pruning</span>
                                        <span class="variant-count">0</span>
                                    </button>
                                    <button class="filter-btn" data-filter="both" onclick="applyVariantFilter('both')">
                                        <span>â­ Significant + After LD</span>
                                        <span class="variant-count">0</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="pagination-section">
                                <div class="page-size-selector">
                                    <label>Show:</label>
                                    <select onchange="changePageSize(this.value)">
                                        <option value="25">25 per page</option>
                                        <option value="50" selected>50 per page</option>
                                        <option value="100">100 per page</option>
                                        <option value="200">200 per page</option>
                                    </select>
                                </div>
                                <div class="page-info" id="pageInfo">Loading...</div>
                            </div>
                        </div>

                        <div class="table-wrapper">
                        <table class="variant-table">
                            <thead>
                                <tr>
                                    <th>rs-ID</th>
                                    <th>Position</th>
                                    <th>Ref/Alt</th>
                                    <th>EUR</th>
                                    <th>AFR</th>
                                    <th>AMR</th>
                                    <th>EAS</th>
                                    <th>SAS</th>
                                    <th>After LD</th>
                                    <th>Significance*</th>
                                    <th>Visualize</th>
                                </tr>
                            </thead>
                            <tbody id="variantsTableBody">
                            </tbody>
                        </table>
                        </div>
                        
                        <div class="variant-controls" style="margin-top: 20px;">
                            <div class="pagination-section">
                                <div class="page-info" id="pageInfo2">Loading...</div>
                                <div class="pagination-controls" id="paginationControls"></div>
                            </div>
                        </div>
                        
                        <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                            <strong>*Significance:</strong> Bonferroni-corrected p-value &lt; 0.01. Click "ðŸ“Š View Stats" to see detailed p-values and FST values for each population.<br>
                            <strong>After LD:</strong> âœ“ Kept = variant retained after LD pruning; âœ— Pruned = removed during LD pruning
                        </p>
                    `;
                    
                    // Initialize display
                    displayVariants();
                    
                    // Sync both page info displays
                    const observer = new MutationObserver(() => {
                        document.getElementById('pageInfo2').textContent = document.getElementById('pageInfo').textContent;
                    });
                    observer.observe(document.getElementById('pageInfo'), { childList: true, characterData: true, subtree: true });
                }
            } catch (error) {
                modalBody.innerHTML = '<p style="color: red;">Error loading details</p>';
            }
        }

        function closeModal() {
            document.getElementById('geneModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('geneModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function showChart(rsId, frequencies, globalAf) {
            const chartRow = document.getElementById(`chart-row-${rsId}`);
            const canvas = document.getElementById(`chart-${rsId}`);
            
            if (chartRow.style.display === 'none') {
                // Close any other open chart rows and stats rows
                document.querySelectorAll('[id^="chart-row-"]').forEach(row => {
                    if (row.id !== `chart-row-${rsId}`) {
                        row.style.display = 'none';
                    }
                });
                document.querySelectorAll('[id^="stats-row-"]').forEach(row => {
                    row.style.display = 'none';
                });
                
                chartRow.style.display = 'table-row';
                
                if (charts[rsId]) {
                    charts[rsId].destroy();
                }
                
                // Add 1KGP global frequency first, then population-specific frequencies
                const orderedPops = ['1KGP', 'AFR', 'AMR', 'AMR1', 'AMR2', 'EUR', 'EAS', 'SAS', 'GIH', 'ITU', 'STU', 'PJL', 'BEB'];
                const orderedFreqs = orderedPops.map(pop => {
                    if (pop === '1KGP') return globalAf || 0;
                    return frequencies[pop] || 0;
                });
                
                // Distinctive color for 1KGP (dark blue/teal), then population colors
                const colors = [
                    '#0d47a1',  // Dark blue for 1KGP global frequency
                    '#e74c3c', '#f39c12', '#f8c471', '#f9e79f', 
                    '#3498db', '#9b59b6', '#1abc9c', '#16a085', 
                    '#27ae60', '#2ecc71', '#f1c40f', '#e67e22'
                ];
                
                const ctx = canvas.getContext('2d');
                charts[rsId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: orderedPops,
                        datasets: [{
                            label: 'Allele Frequency',
                            data: orderedFreqs,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            title: {
                                display: true,
                                text: `Allele Frequency Distribution - ${rsId}`,
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const label = context[0].label;
                                        if (label === '1KGP') {
                                            return '1000 Genomes Project (Global)';
                                        }
                                        return label;
                                    },
                                    label: function(context) {
                                        return `Allele Frequency: ${context.parsed.y.toFixed(4)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...orderedFreqs) * 1.1,
                                title: {
                                    display: true,
                                    text: 'Allele Frequency',
                                    font: { size: 12, weight: 'bold' }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Population (1KGP = 1000 Genomes Project Global)',
                                    font: { size: 12, weight: 'bold' }
                                }
                            }
                        }
                    }
                });
            } else {
                chartRow.style.display = 'none';
            }
        }

        loadStatistics();
        loadGenes();
    </script>
</body>
</html>